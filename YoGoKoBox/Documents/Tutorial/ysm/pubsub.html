<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Publish-Subscribe</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="jquery.min.js"></script>
    <script src="jquery.powertip.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="doxy-jquery.js"></script>
    <script src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <!-- Bootstrap -->
    <link href="doxygen.css" rel="stylesheet">
    <link href="fonts.css" rel="stylesheet">
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="jquery.smartmenus.bootstrap.css" rel="stylesheet">
    <link href="yogoko.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
      <div id="top">
        <nav class="navbar navbar-inverse">
          <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" id="brand-logo" href="https://www.yogoko.com/"><img height="40px" src="yogoko-logo-svg-fr-white.png" /></a>
              <p class="navbar-text text-center visible-xs">Documentation</p>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="navbar-collapse">
              <p class="navbar-text navbar-left"><span id="projectbrief">YoGoKo Smart Middleware</span></p>
              <ul id="yogoko-navlist" class="nav navbar-nav"></ul>
              <form id="yogoko-searchform" class="navbar-form navbar-left navbar-right hidden-sm hidden-xs">
                 <div class="form-group">
                   <div id="MSearchBox" class="MSearchBoxActive">
                     <div class="input-group">
                       <div class="input-group-addon">
                         <span id="MSearchSelect" class="glyphicon glyphicon-search" aria-hidden="true" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"></span>
                       </div>
                       <input class="form-control" type="text" id="MSearchField" placeholder="" accesskey="S" onfocus="searchBox.OnSearchFieldFocus(true)" onblur="searchBox.OnSearchFieldFocus(false)" onkeyup="searchBox.OnSearchFieldChange(event)">
                       <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()">
                         <span id="search-reset" class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>
                       </a>
                     </div>
                   </div>
                 </div>
              </form>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container-fluid -->
        </nav>
      </div>
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pubsub.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Publish-Subscribe </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <b>Publish-Subscribe</b> mechanism allows publishers to send datagrams to subscribers on a dedicated channel.</p>
<p>Channels are identified by an identifier named "message id".</p>
<p>This mechanism is mainly used for emission and reception of V2X messages.</p>
<div class="image">
<img src="YSM_pubsub2.png" alt="YSM_pubsub2.png"/>
<div class="caption">
Transmission of datagrams from a publisher to subscribers</div></div>
 <h1>Description of commands</h1>
<ul>
<li>Subscribe : An application subscribes to a message id. All messages published to this message id will then be delivered to this application.</li>
<li>Publish : An application publishes a message for delivery to all subscribers.</li>
<li>Request : An application publishes a message for reliable delivery to all subscribers, and waits for their response.</li>
</ul>
<h2>Subscribe command</h2>
<p>The subscribe command may be used by an application to receive messages from publishers or requesters. The application subscribes to a <em><b>message id</b></em>. Depending on the API, it receives messages through a callback method or as an output.</p>
<table class="doxtable">
<tr>
<th>I/O </th><th>Mand. </th><th>Variable </th><th>Description  </th></tr>
<tr>
<td>in </td><td>x </td><td>message id </td><td>Id of the dataflow, e.g. the input CAM message processed by the CaService </td></tr>
<tr>
<td>in </td><td>x </td><td>format </td><td>Requested format for the data flow: Generic, JSON, ASN1, ... </td></tr>
<tr>
<td>out </td><td>x </td><td>subscribe id </td><td>Identifier for the subscription </td></tr>
</table>
<p>Each time a publish/request operation is performed, the client application will receive the content of the message and its metadata via a previously registered callback.</p>
<p>The subscribe callback method is defined as follows:</p>
<table class="doxtable">
<tr>
<th>I/O </th><th>Mand. </th><th>Variable </th><th>Description  </th></tr>
<tr>
<td>in </td><td>x </td><td>message </td><td>Published/requested message </td></tr>
<tr>
<td>in </td><td></td><td>metadata </td><td>Metadata associated with the message </td></tr>
<tr>
<td>in </td><td>x </td><td>Subscribe id </td><td>Subscription identifier </td></tr>
<tr>
<td>in </td><td></td><td>Request id </td><td>Reliable request identifier </td></tr>
<tr>
<td>out </td><td></td><td>message </td><td>Pending response (only relevant for Request) </td></tr>
<tr>
<td>out </td><td></td><td>metadata</td><td>Pending response metadata (only relevant for Request) </td></tr>
</table>
<h3>Code samples</h3>
<p>Subscribe : Neighbouring stations : Subscribe to received CAM message (JSON or XML) and print RSSI, station id, position and distance</p>
<p><b>Command Line</b></p>
<div class="fragment"><div class="line">$ mwpubsub -a 12345 -m MESSAGE_ID -s</div></div><!-- fragment --><p><b>C/C++ API</b></p>
<div class="fragment"><div class="line"><span class="comment">// Callback function called each time a message is published</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> printCamMessage(<span class="keyword">struct</span> choir_pubsub_message* message, int32_t subscription_id, <span class="keywordtype">void</span>* u_data) {</div><div class="line"> <span class="comment">// Data length is stored in message-&gt;data_length</span></div><div class="line"> <span class="comment">// Message data is stored in message-&gt;data</span></div><div class="line"> printf(<span class="stringliteral">&quot;%.*s\n&quot;</span>, message-&gt;data_length, message-&gt;data);</div><div class="line">}</div><div class="line"></div><div class="line">(...)</div><div class="line"></div><div class="line"><span class="comment">// Subscribe to MESSAGE_ID and registrer callback function to printCamMessage</span></div><div class="line"><span class="keywordtype">int</span> subscribe_id = choir_subscribe(choir_handler, MESSAGE_ID, NULL, printCamMessage, NULL);</div></div><!-- fragment --><p><b>Java API</b> </p><div class="fragment"><div class="line"><span class="comment">// Implement an AdaptiveMessageListener callback class</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">class </span>PrintCamMessage <span class="keyword">implements</span> AdaptiveMessageListener {</div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onReceivePublication(AdaptiveMessage message, <span class="keywordtype">int</span> subscriptionId) {</div><div class="line">        System.out.println(message.toString());</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line">(...)</div><div class="line"></div><div class="line"><span class="comment">// Get instance of the PubSubService</span></div><div class="line">pubsubservice = yogokoClient.getPubSubService();</div><div class="line"></div><div class="line"><span class="comment">// Subscribe to the MESSAGEID corresponding to the CAM messages to get them in JSON format</span></div><div class="line">pubsubservice.register(APPLICATIONID, <span class="keyword">new</span> PrintCamMessage());</div><div class="line">cam_subscriptionid = pubsubservice.subscribe( MESSAGE_ID, APPLICATIONID, AdaptiveMessageType.JSON);</div></div><!-- fragment --><p><b>Websocket API (JS)</b> </p><div class="fragment"><div class="line">let ws = new WebSocket(&quot;ws://127.0.0.1:8080/pubsub/sub/32&quot;);</div><div class="line">ws.onmessage = function (msg) {</div><div class="line">  let data = JSON.parse(msg.data);</div><div class="line">  let position = data.cam.camParameters.basicContainer.referencePosition;</div><div class="line">  console.log(&quot;CAM : RSSI =&gt; %s, StationID =&gt; %s, position: =&gt; %s %s, distance: =&gt; %s&quot;,</div><div class="line">              data.header.rssi, data.header.stationID, position.latitude, position.longitude, data.distance);</div><div class="line">}</div></div><!-- fragment --><h2>Publish command</h2>
<p>The publish command may be used by an application to publish messages to subscribers. The message may be sent along with associated metadata which is a series of key-value pairs.</p>
<table class="doxtable">
<tr>
<th>I/O </th><th>Mand. </th><th>Variable </th><th>Description  </th></tr>
<tr>
<td>in </td><td>x </td><td>message id </td><td>Id of the data flow </td></tr>
<tr>
<td>in </td><td>x </td><td>message </td><td>Message to publish </td></tr>
<tr>
<td>in </td><td></td><td>metadata </td><td>Metadata associated with the message </td></tr>
</table>
<h3>Code samples</h3>
<p>Publish : PositionFeed : send position fix to message ID 201 using</p>
<p><b>Command Line</b></p>
<div class="fragment"><div class="line">$ echo &quot;${message}&quot; | mwpubsub -a 12345 -m MESSAGE_ID -p</div></div><!-- fragment --><p><b>C/C++ API</b></p>
<div class="fragment"><div class="line"><span class="comment">// Build a choir_pubsub_message with the message to publish.</span></div><div class="line"><span class="keyword">struct </span>choir_pubsub_message messageToSend = CHOIR_PUBSUB_MESSAGE_INIT;</div><div class="line">(...)</div><div class="line"></div><div class="line"><span class="comment">// Publish message to ID 201.</span></div><div class="line">choir_publish(choir_handler, MESSAGE_ID, &amp;messageToSend);</div></div><!-- fragment --><p><b>Java API</b> </p><div class="fragment"><div class="line"><span class="comment">// Get instance of the PubSubService</span></div><div class="line">pubsubservice = yogokoClient.getPubSubService();</div><div class="line"></div><div class="line"><span class="comment">// Build message to publish</span></div><div class="line">Metadata metadata = <span class="keyword">new</span> Metadata();</div><div class="line">String message = <span class="stringliteral">&quot;Message to send...&quot;</span>;</div><div class="line"></div><div class="line">AdaptativeMessage networkMessage = <span class="keyword">new</span> BasicNetworkMessage( message.getBytes(), metadata, AdaptiveMessageType.ASN1_UPER);</div><div class="line"></div><div class="line"><span class="comment">// Publish message on a given MESSAGEID</span></div><div class="line">pubsubservice.publish(MESSAGEID, networkMessage);</div></div><!-- fragment --><p><b>Websocket API (JS)</b> </p><div class="fragment"><div class="line">// Publish</div><div class="line">let ws = new WebSocket(&quot;ws://127.0.0.1:8080/pubsub/pub/201&quot;);</div><div class="line">ws.onopen = function (msg) {</div><div class="line">  ws.send(&#39;{&quot;latitude&quot;:&quot;48.1350568&quot;, &quot;longitude&quot;:&quot;-1.6221928&quot;}&#39;);</div><div class="line">}</div></div><!-- fragment --><h2>Request command</h2>
<p>The request command may be used by an application to request messages to subscribers. The message may be sent along with associated metadata. The requester will then wait for responses from subcribers.</p>
<table class="doxtable">
<tr>
<th>I/O </th><th>Mand. </th><th>Variable </th><th>Description  </th></tr>
<tr>
<td>in </td><td>x </td><td>Message id </td><td>Id of the data flow </td></tr>
<tr>
<td>in </td><td>x </td><td>message </td><td>Message to publish </td></tr>
<tr>
<td>in </td><td></td><td>metadata </td><td>Metadata associated with the message </td></tr>
<tr>
<td>out </td><td>x </td><td>Response count </td><td>Number of responses received from subscriber(s) </td></tr>
<tr>
<td>out </td><td></td><td>Response messages and metadata </td><td>Response message and associated metadata returned by subscribers </td></tr>
</table>
<h3>Code samples</h3>
<p>Send a Denm Trigger, update and termination</p>
<p><b>Command Line</b></p>
<div class="fragment"><div class="line">$ echo &quot;${message}&quot; | mwpubsub -a 12345 -m MESSAGE_ID -p -R</div></div><!-- fragment --><p><b>C/C++ API</b></p>
<div class="fragment"><div class="line"><span class="comment">// Create and build a DENM trigger message at a json format.</span></div><div class="line"><span class="keywordtype">char</span> * myFormatedMessage = malloc(512*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));</div><div class="line">(...)</div><div class="line"></div><div class="line"><span class="comment">// Build a choir_pubsub_message with the previously build DENM.</span></div><div class="line"><span class="keyword">struct </span>choir_pubsub_message messageToSend = CHOIR_PUBSUB_MESSAGE_INIT;</div><div class="line">(...)</div><div class="line"></div><div class="line"><span class="comment">// Declare a choir_pubsub_message to get the request answer.</span></div><div class="line"><span class="keyword">struct </span>choir_pubsub_message* messageAnswer = NULL;</div><div class="line">uint16_t nbrResponse = 0;</div><div class="line"></div><div class="line"><span class="comment">// Request and print the received answer.</span></div><div class="line">choir_request(choir_handler, MESSAGE_ID, &amp;messageToSend, &amp;nbrResponse, &amp;messageAnswer) != -1)</div><div class="line">printf(<span class="stringliteral">&quot;%.*s\n&quot;</span>, messageAnswer-&gt;data_length, messageAnswer-&gt;data);</div></div><!-- fragment --><p><b>Java API</b> </p><div class="fragment"><div class="line"><span class="comment">// Implement an AdaptiveMessageListener callback class</span></div><div class="line"><span class="keyword">private</span> RequestApplicationExample implements AdaptiveMessageListener {</div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onReceivePublication(AdaptiveMessage message, <span class="keywordtype">int</span> subscriptionId){</div><div class="line">        System.out.println(<span class="stringliteral">&quot;A publication have been received with the following messages : &quot;</span> + message.toString());</div><div class="line">    }</div><div class="line"></div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> <span class="keywordtype">void</span> onReceiveRequest(AdaptiveMessage message, <span class="keywordtype">int</span> subcriptionId, <span class="keywordtype">long</span> requestedId{</div><div class="line">        System.out.println(<span class="stringliteral">&quot;A request have been received with the following message : &quot;</span> +  message.toString());</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">new</span> BasicNetworkMessage(<span class="keyword">new</span> String(<span class="stringliteral">&quot;Response&quot;</span>).getBytes, AdaptiveMessageType.ASN1_UPER);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line">(...)</div><div class="line"></div><div class="line"><span class="comment">// Get instance of the PubSubService</span></div><div class="line">pubsubservice = yogokoClient.getPubSubService();</div><div class="line">pubsubservice.register(APPLICATIONID, <span class="keyword">new</span> RequestApplicationExample());</div><div class="line"></div><div class="line"><span class="comment">// Build message to send with the request</span></div><div class="line">Metadata metadata = <span class="keyword">new</span> Metadata();</div><div class="line">String message = <span class="stringliteral">&quot;request&quot;</span>;</div><div class="line">AdaptiveMessage networkMessage = <span class="keyword">new</span> BasicNetworkMessage(message.getBytes(), metadata, AdaptativeMessageType.ASN1_UPER);</div><div class="line"></div><div class="line"><span class="comment">// Send a request with the previously constructed message</span></div><div class="line">AdaptiveMessage[] replies = pubsubservice.request(MESSAGEID, networkMessage);</div><div class="line"><span class="keywordflow">for</span>( AdaptiveMessage reply : replies){</div><div class="line">    NetworkMessage networkReply = (NetworkMessage) reply;</div><div class="line">    <span class="keywordflow">if</span> (networkReply != null) {</div><div class="line">        System.out.println(<span class="stringliteral">&quot;Reply is &quot;</span> : + <span class="keyword">new</span> String(networkReply.formatData()));</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        System.out.println(<span class="stringliteral">&quot;The reply is null&quot;</span>);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p><b>Websocket API (JS)</b> </p><div class="fragment"><div class="line">let ws = new WebSocket(&quot;ws://127.0.0.1:8080/pubsub/req/25/4545&quot;)</div><div class="line">var request = { (...) }</div><div class="line">ws.send(JSON.stringify(denm))</div></div><!-- fragment --><h1>Sequence diagrams</h1>
<h2>Publish</h2>
<div class="image">
<img src="seq-pubsub-publish.png" alt="seq-pubsub-publish.png"/>
<div class="caption">
PubSub Publish</div></div>
<p> Message distribution</p><ol type="1">
<li>Subscriber provides a unique application id to register to the Pubsub Service</li>
<li>Subscriber subscribes to a message id</li>
<li>Pubsub Service acknowledges the subscription by returning a subscription id</li>
<li>Publisher publishes a message on the message id (may be done multiple times)</li>
<li>Pubsub Service distributes the message to all subscribers</li>
<li>Subscriber unsubscribes from its subscription</li>
<li>Subscriber unregisters its application id from the Pubsub Service</li>
</ol>
<p>Note:</p><ul>
<li>There may be multiple publishers publishing to multiple subscribers</li>
</ul>
<h2>Request</h2>
<div class="image">
<img src="seq-pubsub-request.png" alt="seq-pubsub-request.png"/>
<div class="caption">
PubSub Request</div></div>
<p> Reliable message distribution</p><ol type="1">
<li>Subscriber provides a unique application id to register to the Pubsub Service</li>
<li>Subscriber subscribes to a message id</li>
<li>Pubsub Service acknowledges the subscription by returning a subscription id</li>
<li>Publisher emits a request to the message id, waiting for a reply</li>
<li>Pubsub Service distributes the request to all subscribers, waiting for a reply</li>
<li>Subscriber replies (with or without data)</li>
<li>Pubsub Service sends all replies back to the Publisher</li>
<li>Subscriber unsubscribes from its subscription</li>
<li>Subscriber unregisters its application id from the Pubsub Service</li>
</ol>
<p>Notes:</p><ul>
<li>Reliable message distribution and simple message distribution use the same subscription model and message id space.</li>
<li>Mainly used for many(publishers)-to-one(subscriber) communications. All replies are returned to publisher. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
    <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
        <ul>
            <li class="footer">Generated on Tue Mar 14 2023 16:13:24 by <a href="http://www.doxygen.org/index.html">
                       <img class="footer" src="doxygen.png" alt="doxygen"></a> 1.8.13</li>
        </ul>
    </div>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap.min.js"></script>
    <script src="jquery.smartmenus.min.js"></script>
    <script src="jquery.smartmenus.bootstrap.min.js"></script>
    <script src="yogoko-doxy.js"></script>
  </body>
</html>
